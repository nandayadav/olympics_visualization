<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="js/paper.js"></script>
<script type="text/javascript" src="js/underscore-min.js"></script>
<script type="text/paperscript" canvas="myCanvas">
    var hitOptions = {
        segments: true,
        stroke: true,
        fill: true,
        type: 'Path.Circle',
        tolerance: 1
    };

    var globalNodes = [];
    var olympicEvents = [];
    var info, medals; //Text Info
    var currentNode = null;

    //Event class
    var OlympicEvent = (function() {
      function OlympicEvent(year, color, nodes, xPosition, group) {
        this.year = year;
        this.color = color;
        this.nodes = nodes;
        this.xPosition = xPosition;
        this.group = group;
        this.exploded = false; //Initial state, all countries will be grouped together
        // _.each(this.nodes, function(n){ this.group.addChild(n.circle) });
      }

      OlympicEvent.prototype.initialDraw = function() {
        drawInitialCircles(this.nodes, this.xPosition, this.color, this.year);
        //add to group
        //_.each(this.nodes, function(n){ this.group.addChild(n.circle) });
      };

      return OlympicEvent;
    })();

    //Node class
    var Node = Base.extend({
      initialize: function(name, gold, silver, bronze, gdp, year) {
        this.name = name;
        this.gold = gold;
        this.silver = silver;
        this.bronze = bronze;
        this.gdp = gdp;
        this.year = year;
        this.circle = null;
        this.radius = null;
        this.infoText = null;
        // this.compoundCircle = null;
      },

      explode: function() {
        info.content = this.name;
        medals.content = "Gold: " + this.gold + " Silver: " + this.silver + " Bronze: " + this.bronze;
      }

    });

    setupInfo = function(x, y) {
      var countryStyle, medalsStyle;
      info = new PointText(new Point(x, y));
      countryStyle = new CharacterStyle();
      countryStyle.fontSize = 16;
      countryStyle.fillColor = 'white';
      info.characterStyle = countryStyle;
      medalsStyle = new CharacterStyle();
      medalsStyle.fontSize = 10;
      medalsStyle.fillColor = 'white';
      info.content = "";
      medals = new PointText(new Point(x, y + 20));
      medals.characterStyle = medalsStyle;
      medals.content = "";
    }

    clearInfo = function() {
      info.content = "";
      medals.content = "";
    }

    drawLine = function(pointA, pointB, strokeWidth) {
      var line = new Path.Line(pointA, pointB);
      line.strokeColor = 'white';
      line.strokeWidth = strokeWidth;
    };

    drawAxes = function() {
      var origin, top;
      origin = new Point(50, 650);
      top = new Point(50, 50);
      this.drawLine(top, top.add([0, 600]), 1);
      this.drawLine(origin, origin.add([900, 0]), 1);
      gdpLabel = new PointText(new Point(40, 400));
      gdpLabel.fontSize = 10;
      gdpLabel.fillColor = 'white';
      gdpLabel.content = "GDP per Capita";
      gdpLabel.rotate(270);
      yrLabel = new PointText(origin + [400, 30]);
      yrLabel.fontSize = 10;
      yrLabel.fillColor = 'white';
      yrLabel.content = "Olympic Year";

    };

    drawYears = function(years) {
        yrLabel = new PointText(new Point(70, 690));
        yrLabel.fontSize = 14;
        yrLabel.fillColor = 'white';
        var i = 0;
      _.each(years, function(y) {
          cloned = yrLabel.clone();
          cloned.content = y;
          cloned.position.x += (i * 150);
          i++;
      });

    }

    //Checks if given point and radius will collide with any of already drawn circles
    //returns tolerance(distance) if collision, or false if no collision
    detectCollision = function(countries, point, size) {
      var closeCircle;
      closeCircle = _.find(countries, function(c){ return point.isClose(c.circle.position, size + c.radius); });
      if(closeCircle)
        return closeCircle.radius;
      else
        return false;
    }

    drawInitialCircles = function(countries, xPosition, color, year) {
      var circle, point, size, yPoint, colliding;
      console.log("This.." + year);
      _.each(olympicEvents, function(c){
        console.log("Prev.." + c.year);
      });
      prevEvent = _.find(olympicEvents, function(e){ return (e.year == (year - 4)); });
      if (prevEvent) {
      } else {
        console.log("Prev not found..")
      }

      _.each(countries, function(n) {
        size = n.gold + n.silver + n.bronze;
        size = size / 4;
        if (size < 1) {
          size = 2;
        } else if (size < 5) {
          size = size * 2;
        }
        point = new Point((Math.random() * 100) + xPosition, (Math.random() * 100) + 550);
        circle = new Path.Circle(point, size);
        circle.fillColor = color;
        n.circle = circle;
        n.radius = size;
        tInfo = new PointText(point + [n.radius, 0]);
        info.fontSize = 10;

        if (prevEvent) {
          prevNode = _.find(prevEvent.nodes, function(c){ return (c.name == n.name); });
          if (prevNode) {
            diff = (n.gold + n.silver + n.bronze) - (prevNode.gold + prevNode.silver + prevNode.bronze);
            tInfo.content = "Medals: " + diff + " GDP: " + (n.gdp - prevNode.gdp);
            if (diff >= 0) {
              tInfo.fillColor = 'green';
            } else {
              tInfo.fillColor = 'red';
            }
          } else {
            tInfo.content = "0";
          }

        }
        tInfo.visible = false;
        n.infoText = tInfo;

      });
    };

    //Draws trace of a country as it moves from one olympic event to next
    drawTraces = function(countries) {
      countries = _.sortBy(countries, function(c){ return c.year; });
      var path = new Path();
      path.strokeColor = 'white';
      var first = _.first(countries);
      path.add(first.circle.position);
      _.each(countries, function(c){
        if (c != first) {
          path.add(c.circle.position);
          //path.curveTo(c.circle.position, c.circle.position);
        }
        c.infoText.visible = true;
      });

    }

    fetchData = function(year, xPosition, color) {
      $.ajax({
        url: "/countries?year=" + year,
        type: 'GET',
        dataType: 'json',
        success: function(data) {
          results = [];
          _.each(data, function(f) {
            results.push(new Node(f['name'], f['gold'], f['silver'], f['bronze'], f['gdp'], year));
          });
          globalNodes = results;
          var olympicEvent = new OlympicEvent(year, color, results, xPosition, new Group());
          olympicEvents.push(olympicEvent);
          olympicEvent.initialDraw();
        }

      });
    }


    //Draw lines
    drawAxes();
    //Info setup
    setupInfo(100, 50);
    fetchData(1988, 50, 'green');
    fetchData(1992, 200, 'white');
    fetchData(1996, 350, 'orange');
    fetchData(2000, 500, 'teal');
    fetchData(2004, 650, 'yellow');
    fetchData(2008, 800, 'red');

    drawYears([1988, 1992, 1996, 200, 2004, 2008]);
    function onMouseMove(event) {
      var hitResult = project.hitTest(event.point, hitOptions);
      var allNodes = _.map(olympicEvents, function(event){ return event.nodes; });
      allNodes = _.flatten(allNodes);
      if (hitResult && hitResult.item) {
        var hitPoint = hitResult.item.position;

        //console.log("Size: " + allNodes.length);
        _.each(allNodes, function(n){
          if (hitPoint.isClose(n.circle.position, n.radius)) {
            _.each(allNodes, function(k){
              if (k !== n ) {
                k.circle.opacity = 0.4;
                //k.circle.visible = false;
              }
            });
            n.explode();
          }
        });
      } else {
        clearInfo();
        _.each(allNodes, function(n){
          n.circle.opacity = 1;
        });
        //_.each(allNodes, function(i){ i.circle.visible = true; });
      }
    }

    function onMouseUp(even) {
      var allNodes = _.map(olympicEvents, function(event){ return event.nodes; });
      allNodes = _.flatten(allNodes);
      _.each(allNodes, function(n) {
        n.circle.visible = true;
        n.infoText.visible = false;
      });
    }

    function onMouseDown(event) {
      var colliding;
      var drawnCountries = [];
      var hitResult = project.hitTest(event.point, hitOptions);
      var allNodes = _.map(olympicEvents, function(event){ return event.nodes; });
      allNodes = _.flatten(allNodes);
      var hitCountry;
      if (hitResult && hitResult.item) {
        hitCountry = _.find(allNodes, function(c){ return hitResult.item.position.isClose(c.circle.position, c.radius); });
        console.log("Country found" + hitCountry);
      }
      if (hitCountry) {
        var connectedCountries = []
        _.each(allNodes, function(n) {
          if (n.name != hitCountry.name) {
            n.circle.visible = false;
          } else {
            connectedCountries.push(n);
          }
        });
        drawTraces(connectedCountries);
      } else {
        _.each(allNodes, function(n) {
          yPoint = 650 - (n.gdp / 100);
          if (yPoint < 50) {
            yPoint = 50;
          }
          n.circle.position.y = yPoint;
          //detect if its colliding with another circle
          colliding = detectCollision(drawnCountries, n.circle.position, n.radius);
          if(colliding) {
            n.circle.position.x += 2*colliding;
          } else {
            //console.log("NO collision, moving on..")
          }
          n.infoText.position = n.circle.position + [n.radius, 0];
          drawnCountries.push(n);
        });
      }

    }

</script>
</head>
<body>
    <canvas id="myCanvas" width="1200" height="800" style="background-color: #000;"></canvas>
</body>
</html>
